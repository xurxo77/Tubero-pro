<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XURXO - Tubero Pro Elite v19.0</title>
    <!-- Librerías de exportación -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-body: #0f172a;
            --primary: #1e293b;
            --accent: #f59e0b;
            --blue-pro: #0284c7;
            --text-main: #334155;
            --text-light: #94a3b8;
            --workshop-green: #059669;
            --pdf-red: #ef4444;
            --error-red: #b91c1c;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            padding: 10px;
            display: flex;
            justify-content: center;
            overflow-x: hidden;
        }

        /* --- PANTALLA DE INICIO (SPLASH SCREEN) --- */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #1e293b 0%, #0f172a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.8s ease, visibility 0.8s;
            color: white;
            text-align: center;
        }

        .splash-logo {
            font-size: 3rem;
            font-weight: 900;
            letter-spacing: 5px;
            color: var(--accent);
            text-shadow: 0 0 20px rgba(245, 158, 11, 0.4);
            margin-bottom: 10px;
            animation: fadeInDown 1s ease forwards;
            opacity: 0;
        }

        .splash-divider {
            width: 0;
            height: 4px;
            background: var(--accent);
            margin-bottom: 20px;
            animation: growLine 1.2s ease 0.5s forwards;
        }

        .splash-name {
            font-size: 1.2rem;
            font-weight: 300;
            letter-spacing: 3px;
            text-transform: uppercase;
            animation: fadeInUp 1s ease 1s forwards;
            opacity: 0;
        }

        .splash-version {
            margin-top: 30px;
            font-family: monospace;
            color: var(--text-light);
            font-size: 0.8rem;
            animation: fadeIn 1s ease 1.5s forwards;
            opacity: 0;
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        @keyframes growLine {
            from { width: 0; }
            to { width: 150px; }
        }

        /* --- INTERFAZ PRINCIPAL --- */
        .app-container {
            width: 100%;
            max-width: 500px;
            background: #f1f5f9;
            min-height: 98vh;
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            position: relative;
        }

        header {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white;
            padding: 25px 15px;
            text-align: center;
            border-bottom: 4px solid var(--accent);
        }

        .owner-badge {
            background: var(--accent);
            color: #000;
            padding: 4px 15px;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 800;
            display: inline-block;
            margin-top: 8px;
            text-transform: uppercase;
        }

        #ui-message {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error-red);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
            display: none;
            width: 90%;
            text-align: center;
        }

        .nav-tabs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            background: #1e293b;
            gap: 1px;
        }

        .tab-btn {
            background: #1e293b;
            border: none;
            color: #94a3b8;
            padding: 12px 5px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            transition: 0.3s;
        }

        .tab-btn svg { width: 18px; height: 18px; fill: currentColor; margin-bottom: 4px; }

        .tab-btn.active {
            color: var(--accent);
            background: #334155;
            border-bottom: 3px solid var(--accent);
        }

        .main-content { flex: 1; padding: 15px; overflow-y: auto; }
        .section { display: none; }
        .section.active { display: block; }

        h2 { font-size: 1.1rem; color: var(--primary); margin-bottom: 12px; border-left: 4px solid var(--accent); padding-left: 10px; }

        .card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; margin-bottom: 4px; text-transform: uppercase; }
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
        }

        .btn-main {
            background: var(--blue-pro);
            color: white;
            border: none;
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .canvas-wrap {
            background: #0f172a;
            border-radius: 15px;
            margin-top: 15px;
            padding: 15px;
            overflow: hidden;
            border: 1px solid #334155;
        }

        .canvas-label {
            font-size: 0.65rem;
            color: var(--accent);
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .radio-group { display: flex; gap: 8px; }
        .radio-btn {
            flex: 1; padding: 12px; background: #e2e8f0; border-radius: 10px; text-align: center;
            font-size: 0.8rem; font-weight: 700; cursor: pointer;
        }
        .radio-btn.active { background: var(--blue-pro); color: white; }

        #loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95);
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white;
            text-align: center; padding: 20px;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        .data-table th { background: #1e293b; color: white; padding: 10px; text-align: center; }
        .data-table td { border-bottom: 1px solid #e2e8f0; padding: 10px; text-align: center; font-weight: 600; }
        
        .sling-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; background: white; padding: 12px; border-radius: 12px; }
    </style>
</head>
<body>

<!-- PANTALLA DE INICIO -->
<div id="splash-screen">
    <div class="splash-logo">TUBERO PRO</div>
    <div class="splash-divider"></div>
    <div class="splash-name">OFICIAL: XURXO</div>
    <div class="splash-version">BUILD 2024 - v19.0 INDUSTRIAL</div>
</div>

<div id="ui-message">Aviso</div>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 10px;">PROCESANDO DOCUMENTOS</div>
    <div id="loading-msg" style="font-size: 0.9rem; color: var(--accent); max-width: 300px;">
        XURXO, estamos preparando la información técnica...
    </div>
</div>

<div class="app-container" id="capture-area">
    <header>
        <h1>TUBERO PRO</h1>
        <div class="owner-badge">OFICIAL: XURXO</div>
        <div class="subtitle">EDICIÓN ELITE v19.0</div>
    </header>

    <nav class="nav-tabs" id="nav-ignore">
        <button class="tab-btn active" onclick="setTab('tab-bocapez', this)"><svg viewBox="0 0 24 24"><path d="M12,2L4.5,20.29L5.21,21L12,18L18.79,21L19.5,20.29L12,2Z"/></svg>Boca Pez</button>
        <button class="tab-btn" onclick="setTab('tab-bayoneta', this)"><svg viewBox="0 0 24 24"><path d="M21,16.5L12,21.5L3,16.5V7.5L12,2.5L21,7.5V16.5Z"/></svg>Bayoneta</button>
        <button class="tab-btn" onclick="setTab('tab-bridas', this)"><svg viewBox="0 0 24 24"><path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5Z"/></svg>Bridas</button>
        <button class="tab-btn" onclick="setTab('tab-pesos', this)"><svg viewBox="0 0 24 24"><path d="M12,3L1,9L12,15L21,10V17H23V9M5,13V17L12,21L19,17V13L12,17L5,13Z"/></svg>Pesos</button>
        <button class="tab-btn" onclick="setTab('tab-codos', this)"><svg viewBox="0 0 24 24"><path d="M19,15V19H5V5H9V3H5C3.9,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V15H19M16,3H21V8H19V6.4L11.9,13.5L10.5,12.1L17.6,5H16V3Z"/></svg>Codos</button>
        <button class="tab-btn" onclick="setTab('tab-cargas', this)"><svg viewBox="0 0 24 24"><path d="M13,10H18L12,16L6,10H11V3H13V10M4,19H20V21H4V19Z"/></svg>Izaje</button>
    </nav>

    <div class="main-content">
        
        <!-- PESTAÑA BOCA PEZ -->
        <div id="tab-bocapez" class="section active">
            <h2>Injerto Boca de Pez (Ángulo Variable)</h2>
            <div class="card" id="form-ignore">
                <div class="input-group">
                    <label>Unidades</label>
                    <div class="radio-group">
                        <div class="radio-btn active" id="unIn" onclick="setUn('in')">Pulgadas</div>
                        <div class="radio-btn" id="unMm" onclick="setUn('mm')">mm</div>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                    <div class="input-group"><label>Cabezal (OD)</label><input type="number" id="bpC" placeholder="6"></div>
                    <div class="input-group"><label>Ramal (OD)</label><input type="number" id="bpR" placeholder="4"></div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                    <div class="input-group"><label>Ángulo Inclinación (°)</label><input type="number" id="bpAng" value="90"></div>
                    <div class="input-group">
                        <label>Divisiones</label>
                        <div class="radio-group">
                            <div class="radio-btn active" id="div8" onclick="setDiv(8)">8</div>
                            <div class="radio-btn" id="div16" onclick="setDiv(16)">16</div>
                        </div>
                    </div>
                </div>
                <label style="display:flex; align-items:center; gap:10px; font-size:0.85rem; background:#fff7ed; padding:12px; border-radius:10px; border:1px solid #ffedd5; color:#9a3412; cursor:pointer;">
                    <input type="checkbox" id="bpMarg" style="width:18px; height:18px;"> +30mm Faja de Papel
                </label>
                <button class="btn-main" style="margin-top:15px;" onclick="calcBP()">Generar Informe y Trazado</button>
            </div>

            <div id="resBP" style="display:none">
                <div class="canvas-wrap">
                    <div class="canvas-label">Vista Técnica de Montaje</div>
                    <svg id="jointSvg" viewBox="0 0 400 300" style="background: #0f172a;"></svg>
                </div>

                <div style="background:#eff6ff; padding:15px; border-radius:15px; margin-bottom:15px; border:2px solid #3b82f6; display:flex; justify-content: space-around; text-align: center; margin-top: 15px;">
                    <div><div style="font-size:0.65rem; color:#1e40af; font-weight:800;">PERÍMETRO</div><div id="bpPer" style="font-size:1.1rem; font-weight:900; color:#1e3a8a;">0</div></div>
                    <div style="width:1px; background:#bfdbfe;"></div>
                    <div><div style="font-size:0.65rem; color:#1e40af; font-weight:800;">PASO</div><div id="bpPas" style="font-size:1.1rem; font-weight:900; color:#1e3a8a;">0</div></div>
                </div>
                
                <div class="card" id="btns-ignore">
                    <div class="input-group">
                        <label>Formato de Papel (1:1)</label>
                        <div class="radio-group">
                            <div class="radio-btn active" id="formatA4" onclick="setFormat('a4')">A4 Apaisado</div>
                            <div class="radio-btn" id="formatA3" onclick="setFormat('a3')">Plano A3</div>
                        </div>
                    </div>
                    <button class="btn-main" style="background:var(--workshop-green)" onclick="pdfMultiPaginado()">
                        EXPORTAR PLANTILLA 1:1
                    </button>
                    <button class="btn-main" style="background:var(--pdf-red); margin-top:8px;" onclick="pdfInforme()">
                        EXPORTAR FICHA TÉCNICA
                    </button>
                </div>

                <div class="card" style="padding:0; overflow:hidden;">
                    <table class="data-table" id="tableBP">
                        <thead><tr><th>PTO</th><th>GRAD</th><th>ORD (mm)</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="canvas-wrap">
                    <div class="canvas-label">Plantilla para Corte</div>
                    <svg id="bpSvg" viewBox="0 0 400 160"></svg>
                </div>
            </div>
        </div>

        <!-- BAYONETAS -->
       <div id="tab-bayoneta" class="section">
    <h2>Cálculo de Bayonetas</h2>
    <div class="card">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
            <div class="input-group">
                <label>Avance (Run)</label>
                <input type="number" id="byRun" placeholder="mm">
            </div>
            <div class="input-group">
                <label>Altura (Set)</label> <input type="number" id="bySet" placeholder="mm">
            </div>
        </div>

        <div class="input-group">
            <label>Unidad Diámetro</label>
            <div class="radio-group" style="margin-bottom:10px;">
                <div class="radio-btn active" id="btnDiaIn" onclick="toggleDiaUnit('in')">Pulgadas (")</div>
                <div class="radio-btn" id="btnDiaMm" onclick="toggleDiaUnit('mm')">Milímetros (mm)</div>
            </div>
            
            <div id="inputDiaIn">
                <select id="byDiaSel" style="background:#fff;">
                    <option value="2">2"</option>
                    <option value="3">3"</option>
                    <option value="4" selected>4"</option>
                    <option value="6">6"</option>
                    <option value="8">8"</option>
                    <option value="10">10"</option>
                    <option value="12">12"</option>
                    <option value="14">14"</option>
                    <option value="16">16"</option>
                </select>
            </div>
            <div id="inputDiaMm" style="display:none;">
                <input type="number" id="byDiaInp" placeholder="Ej: 100 (para DN100)" style="background:#fff;">
            </div>
        </div>

        <div class="input-group">
            <label>Radio Codo</label>
            <div class="radio-group">
                <div class="radio-btn active" id="byLR" onclick="setByRad('LR')">Largo (x1.5)</div>
                <div class="radio-btn" id="bySR" onclick="setByRad('SR')">Corto (x1.0)</div>
            </div>
        </div>

        <button class="btn-main" style="margin-top:15px;" onclick="calcBayonetaPro()">Calcular Trazado</button>
    </div>

    <div id="resByPro" style="display:none;">
        <div class="canvas-wrap" style="padding:10px;">
            <div class="canvas-label">Esquema de Montaje</div>
            <svg id="bySvg" style="width:100%; height:auto; background:#0f172a; border-radius:10px; min-height:200px;"></svg>
        </div>

        <div class="card" style="background:#f0fdf4; border:1px solid #bbf7d0;">
            <table class="data-table">
                <tr>
                    <td style="text-align:left; color:#166534;">Ángulo Codos</td>
                    <td style="font-weight:900; color:#166534; font-size:1.1rem;" id="outByAng">0°</td>
                </tr>
                <tr>
                    <td style="text-align:left;">Recorrido (C-C)</td>
                    <td style="font-weight:bold;" id="outByTrav">0</td>
                </tr>
                <tr>
                    <td style="text-align:left;">Avance Codo (x2)</td>
                    <td style="font-weight:bold; color:#ef4444;" id="outByDesc">0</td>
                </tr>
                <tr style="background:#dcfce7;">
                    <td style="text-align:left; font-weight:800; color:#15803d;">CARRETE (CORTE)</td>
                    <td style="font-weight:900; font-size:1.4rem; color:#15803d;" id="outByCut">0</td>
                </tr>
            </table>
        </div>
    </div>
</div>

        <!-- BRIDAS -->
        <div id="tab-bridas" class="section">
            <h2>Manual ASME B16.5</h2>
            <div class="card">
                <div class="input-group"><label>NPS</label>
                    <select id="brSize">
                        <option value="2">2"</option><option value="3">3"</option><option value="4" selected>4"</option>
                        <option value="6">6"</option><option value="8">8"</option><option value="12">12"</option>
                    </select>
                </div>
                <div class="input-group"><label>Clase</label>
                    <select id="brClass"><option value="150">150#</option><option value="300">300#</option></select>
                </div>
                <button class="btn-main" onclick="getBrida()">Consultar Datos</button>
            </div>
            <div id="brRes" class="card" style="display:none">
                <table class="data-table">
                    <tr><td>Ext. (OD)</td><td id="brOD">0</td></tr>
                    <tr><td>Centro (BC)</td><td id="brBC">0</td></tr>
                    <tr><td>Agujeros</td><td id="brH">0</td></tr>
                    <tr><td>Llave (mm)</td><td id="brW">0</td></tr>
                </table>
            </div>
        </div>

        <!-- PESOS -->
        <div id="tab-pesos" class="section">
            <h2>Cálculo de Pesos</h2>
            <div class="card">
                <div class="input-group"><label>Diámetro</label>
                    <select id="pD"><option value="4" selected>4"</option><option value="6">6"</option><option value="8">8"</option></select>
                </div>
                <div class="input-group"><label>Schedule</label>
                    <select id="pS"><option value="40">Sch 40</option><option value="80">Sch 80</option></select>
                </div>
                <div class="input-group"><label>Largo (m)</label><input type="number" id="pL" placeholder="6"></div>
                <button class="btn-main" onclick="calcPeso()">Calcular Kg</button>
            </div>
            <div id="resP" class="result-box" style="display:none; text-align:center; background:#fefce8;"><div class="res-val" id="resPVal">0 Kg</div></div>
        </div>

        <!-- CODOS -->
        <div id="tab-codos" class="section">
            <h2>Avance Codos</h2>
            <div class="card">
                <div class="input-group"><label>Diámetro (In)</label><input type="number" id="coD" placeholder="4"></div>
                <div class="input-group"><label>Ángulo (°)</label><input type="number" id="coA" value="90"></div>
                <div class="radio-group">
                    <div class="radio-btn active" id="coLR" onclick="setCo('LR')">R. Largo</div>
                    <div class="radio-btn" id="coSR" onclick="setCo('SR')">R. Corto</div>
                </div>
                <button class="btn-main" style="margin-top:15px" onclick="calcCo()">Calcular</button>
            </div>
            <div id="resCo" class="result-box" style="display:none; text-align:center;"><div class="res-val" id="resCoVal">0 mm</div></div>
        </div>

        <!-- ESLINGAS -->
        <div id="tab-cargas" class="section">
            <h2>Eslingas</h2>
            <div id="slingList"></div>
        </div>

    </div>
</div>


   <script>
    // --- LÓGICA DE INICIO (SPLASH) ---
    window.addEventListener('load', () => {
        setTimeout(() => {
            const splash = document.getElementById('splash-screen');
            splash.style.opacity = '0';
            setTimeout(() => { splash.style.display = 'none'; }, 800);
        }, 3000); 
    });

    let unitBP = 'in', divBP = 8, exportFormat = 'a4', coType = 'LR';
    let lastBP = { pts: [], per: 0, r: 0, c: 0, unit: 'in', paso: 0, angle: 90 };

    function showMsg(text) {
        const box = document.getElementById('ui-message');
        box.innerText = text; box.style.display = 'block';
        setTimeout(() => { box.style.display = 'none'; }, 3000);
    }

    function setTab(id, btn) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    function setFormat(f) {
        exportFormat = f;
        document.getElementById('formatA4').classList.toggle('active', f==='a4');
        document.getElementById('formatA3').classList.toggle('active', f==='a3');
    }

    function getOD(inch) {
        const m = {"2":60.3, "3":88.9, "4":114.3, "6":168.3, "8":219.1, "10":273.0, "12":323.8};
        return m[inch] || inch * 25.4;
    }

    function setUn(u) { unitBP = u; document.getElementById('unIn').classList.toggle('active', u==='in'); document.getElementById('unMm').classList.toggle('active', u==='mm'); }
    function setDiv(d) { divBP = d; document.getElementById('div8').classList.toggle('active', d===8); document.getElementById('div16').classList.toggle('active', d===16); }
    function setCo(t) { coType = t; document.getElementById('coLR').classList.toggle('active', t==='LR'); document.getElementById('coSR').classList.toggle('active', t==='SR'); }

    // --- BOCA PEZ ---
    function calcBP() {
        let cIn = parseFloat(document.getElementById('bpC').value);
        let rIn = parseFloat(document.getElementById('bpR').value);
        let ang = parseFloat(document.getElementById('bpAng').value);
        let marg = document.getElementById('bpMarg').checked ? 30 : 0;
        if(!cIn || !rIn || !ang) { showMsg("Faltan datos"); return; }

        let R_cab = (unitBP === 'in' ? getOD(cIn) : cIn) / 2;
        let r_ram = (unitBP === 'in' ? getOD(rIn) : rIn) / 2;
        let angRad = ang * Math.PI / 180;
        
        if(r_ram > R_cab) { showMsg("Ramal > Cabezal"); return; }

        let per = (r_ram * 2) * Math.PI;
        let paso = per / divBP;
        lastBP = { per, r: rIn, c: cIn, pts: [], unit: unitBP, paso: paso, angle: ang };
        
        let tbody = document.querySelector("#tableBP tbody");
        tbody.innerHTML = "";
        for(let i=0; i<=divBP; i++){
            let phi = (i * 360 / divBP) * Math.PI / 180;
            let y = (Math.sqrt(Math.pow(R_cab, 2) - Math.pow(r_ram * Math.sin(phi), 2)) / Math.sin(angRad)) - (r_ram * Math.cos(phi) / Math.tan(angRad));
            lastBP.pts.push(y);
        }

        let minY = Math.min(...lastBP.pts);
        lastBP.pts = lastBP.pts.map(y => (y - minY) + marg);
        lastBP.pts.forEach((p, i) => { tbody.innerHTML += `<tr><td>${i}</td><td>${(i*360/divBP)}°</td><td>${p.toFixed(1)}</td></tr>`; });
        
        document.getElementById('resBP').style.display = 'block';
        document.getElementById('bpPer').innerText = per.toFixed(1) + " mm";
        document.getElementById('bpPas').innerText = paso.toFixed(1) + " mm";
        
        drawJointSvg(R_cab, r_ram, ang);
        drawTemplateSvg();
    }

    function drawJointSvg(R, r, ang) {
        const svg = document.getElementById('jointSvg');
        const angRad = ang * Math.PI / 180;
        const scale = 110 / (R * 2);
        const scR = R * scale, scr = r * scale;
        const cx = 150, cy = 200, L = 160;
        const vx = Math.cos(angRad), vy = -Math.sin(angRad);
        const px = Math.sin(angRad), py = Math.cos(angRad);
        
        let content = `<rect width="400" height="300" fill="#0f172a"/>`;
        content += `<rect x="40" y="${cy - scR}" width="320" height="${scR * 2}" fill="none" stroke="#475569" stroke-width="2" rx="2"/>`;
        content += `<line x1="30" y1="${cy}" x2="370" y2="${cy}" stroke="#334155" stroke-dasharray="10,5,2,5"/>`;
        const x1 = cx - scr * px, y1 = cy - scR - scr * py;
        const x2 = cx + scr * px, y2 = cy - scR + scr * py;
        content += `<line x1="${x1}" y1="${y1}" x2="${x1 + L * vx}" y2="${y1 + L * vy}" stroke="white" stroke-width="2.5"/>`;
        content += `<line x1="${x2}" y1="${y2}" x2="${x2 + L * vx}" y2="${y2 + L * vy}" stroke="white" stroke-width="2.5"/>`;
        content += `<line x1="${cx}" y1="${cy - scR}" x2="${cx + (L+30) * vx}" y2="${cy - scR + (L+30) * vy}" stroke="var(--accent)" stroke-width="1" stroke-dasharray="10,5,2,5"/>`;
        content += `<line x1="${x1 + L * vx}" y1="${y1 + L * vy}" x2="${x2 + L * vx}" y2="${y2 + L * vy}" stroke="white" stroke-width="2.5"/>`;
        content += `<text x="50" y="${cy + scR + 25}" fill="#94a3b8" font-size="11" font-weight="bold">CABEZAL Ø: ${lastBP.c}</text>`;
        content += `<text x="${cx + 40}" y="${cy - scR - 20}" fill="var(--accent)" font-size="18" font-weight="black">${ang}°</text>`;
        svg.innerHTML = content;
    }

    function drawTemplateSvg() {
        let svg = document.getElementById('bpSvg');
        let w = 400, step = w/divBP, scY = 120/Math.max(...lastBP.pts);
        let path = `M 0 ${160 - lastBP.pts[0]*scY}`;
        lastBP.pts.forEach((p, i) => path += ` L ${i*step} ${160 - p*scY}`);
        svg.innerHTML = `<rect width="400" height="160" fill="#0f172a"/><path d="${path}" stroke="var(--accent)" stroke-width="4" fill="none" stroke-linejoin="round"/>`;
    }

    async function pdfInforme() {
        if(!lastBP.pts.length) return;
        const overlay = document.getElementById('loading-overlay');
        overlay.style.display = 'flex';
        try {
            document.getElementById('nav-ignore').style.display = 'none';
            document.getElementById('form-ignore').style.display = 'none';
            document.getElementById('btns-ignore').style.display = 'none';
            const canvas = await html2canvas(document.getElementById('capture-area'), { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            pdf.setFontSize(18); pdf.text("INFORME TÉCNICO - XURXO", 105, 15, { align: 'center' });
            pdf.addImage(imgData, 'PNG', 10, 25, 190, (canvas.height * 190) / canvas.width);
            pdf.save(`Informe_Xurxo_${lastBP.r}.pdf`);
        } finally {
            document.getElementById('nav-ignore').style.display = 'grid';
            document.getElementById('form-ignore').style.display = 'block';
            document.getElementById('btns-ignore').style.display = 'block';
            overlay.style.display = 'none';
        }
    }

    function pdfMultiPaginado() {
        if(!lastBP.pts.length) return;
        const overlay = document.getElementById('loading-overlay');
        overlay.style.display = 'flex';
        setTimeout(() => {
            try {
                const { jsPDF } = window.jspdf;
                const isA3 = (exportFormat === 'a3');
                const pW = isA3 ? 420 : 297, pH = isA3 ? 297 : 210, margin = 15;
                const drawableW = pW - (margin * 2);
                const numPages = Math.ceil(lastBP.per / drawableW);
                const doc = new jsPDF({ orientation: 'l', unit: 'mm', format: exportFormat });
                
                for (let p = 0; p < numPages; p++) {
                    if (p > 0) doc.addPage();
                    doc.setFontSize(14); doc.text(`XURXO 1:1 (${exportFormat.toUpperCase()}) - PÁG ${p+1}/${numPages}`, margin, 12);
                    doc.setFontSize(10); doc.text(`Ramal: ${lastBP.r} | Ángulo: ${lastBP.angle}°`, margin, 18);
                    doc.setDrawColor(255, 0, 0); doc.line(margin, 25, margin + 100, 25);
                    doc.text("VERIFICAR: 100mm", margin + 20, 24);

                    const startX_Abs = p * drawableW, yBase = 45;
                    const step = lastBP.paso;
                    for (let i = 0; i < lastBP.pts.length; i++) {
                        let xAbs = i * step;
                        if (xAbs >= startX_Abs - 1 && xAbs <= (p + 1) * drawableW + 1) {
                            let xRel = xAbs - startX_Abs + margin, yOrd = yBase + lastBP.pts[i];
                            doc.setDrawColor(200); doc.line(xRel, yBase, xRel, yOrd);
                            doc.setFontSize(8); doc.text(i.toString(), xRel, yBase - 3, {align: 'center'});
                        }
                    }
                    doc.setDrawColor(0); doc.setLineWidth(0.8);
                    for (let i = 0; i < lastBP.pts.length - 1; i++) {
                        let x1_A = i * step, x2_A = (i + 1) * step;
                        if (x2_A > startX_Abs && x1_A < (p + 1) * drawableW) {
                            let x1_R = Math.max(0, x1_A - startX_Abs) + margin, x2_R = Math.min(drawableW, x2_A - startX_Abs) + margin;
                            doc.line(x1_R, yBase + lastBP.pts[i], x2_R, yBase + lastBP.pts[i+1]);
                        }
                    }
                    if (p < numPages - 1) {
                        doc.setLineDash([1, 1], 0); doc.line(pW - margin, 40, pW - margin, pH - margin);
                        doc.setLineDash([], 0); doc.text("SOLAPE →", pW - margin - 5, pH/2, {angle: 90});
                    }
                }
                doc.save(`Plantilla_Xurxo_${lastBP.r}.pdf`);
            } catch (err) { showMsg("Error PDF"); }
            overlay.style.display = 'none';
        }, 800);
    }

 // --- LÓGICA MEJORADA DE BAYONETA (VERSIÓN 2.0) ---
    let byType = 'LR'; // Radio Largo por defecto
    let byUnitDia = 'in'; // Unidad defecto

    function setByRad(t) {
        byType = t;
        document.getElementById('byLR').classList.toggle('active', t === 'LR');
        document.getElementById('bySR').classList.toggle('active', t === 'SR');
    }

    function toggleDiaUnit(u) {
        byUnitDia = u;
        document.getElementById('btnDiaIn').classList.toggle('active', u === 'in');
        document.getElementById('btnDiaMm').classList.toggle('active', u === 'mm');
        document.getElementById('inputDiaIn').style.display = (u === 'in') ? 'block' : 'none';
        document.getElementById('inputDiaMm').style.display = (u === 'mm') ? 'block' : 'none';
    }

    function calcBayonetaPro() {
        const run = parseFloat(document.getElementById('byRun').value);
        const set = parseFloat(document.getElementById('bySet').value);
        
        // Obtener diámetro base según la unidad seleccionada
        let diameterBase = 0;
        if (byUnitDia === 'in') {
            diameterBase = parseFloat(document.getElementById('byDiaSel').value) * 25.4; // Pulgadas a mm
        } else {
            diameterBase = parseFloat(document.getElementById('byDiaInp').value); // Ya está en mm
        }
        
        if (!run || !set || !diameterBase) { showMsg("Faltan datos (Avance, Altura o Diámetro)"); return; }

        // Cálculos
        const travel = Math.sqrt(Math.pow(run, 2) + Math.pow(set, 2));
        const angleRad = Math.atan(set / run);
        const angleDeg = angleRad * (180 / Math.PI);

        // Radio del codo (Largo = 1.5D, Corto = 1.0D)
        const radius = (byType === 'LR') ? (diameterBase * 1.5) : (diameterBase * 1.0);
        
        const elbowAdv = radius * Math.tan(angleRad / 2);
        const totalDeduct = elbowAdv * 2; 
        const cutLength = travel - totalDeduct;

        // Mostrar Resultados
        document.getElementById('resByPro').style.display = 'block';
        document.getElementById('outByAng').innerText = angleDeg.toFixed(1) + "°";
        document.getElementById('outByTrav').innerText = travel.toFixed(1) + " mm";
        document.getElementById('outByDesc').innerText = "-" + totalDeduct.toFixed(1) + " mm";
        
        const cutElem = document.getElementById('outByCut');
        if (cutLength < 0) {
            cutElem.innerText = "IMPOSIBLE";
            cutElem.style.color = "red";
            showMsg("¡Cuidado! Los codos se solapan.");
        } else {
            cutElem.innerText = cutLength.toFixed(1) + " mm";
            cutElem.style.color = "#15803d";
        }

        // Llamada al dibujo responsive
        drawBayonetaSvgResponsive(run, set, cutLength, angleDeg);
    }

    function drawBayonetaSvgResponsive(run, set, cut, ang) {
        const svg = document.getElementById('bySvg');
        svg.innerHTML = ''; // Limpiar

        // Definir márgenes lógicos (en unidades del dibujo)
        const margin = Math.max(run, set) * 0.15 + 40; // Margen dinámico + base fija
        
        // Coordenadas lógicas
        const xStart = 0;
        const yStart = 0; // Eje Y invertido visualmente en SVG, pero calculamos normal y luego ajustamos
        const xEnd = run;
        const yEnd = -set; // Negativo porque en SVG Y crece hacia abajo

        // Calcular ViewBox (La caja que encuadra todo el dibujo)
        // xMin, yMin, width, height
        const vbX = -margin;
        const vbY = -set - margin; // Arriba del todo
        const vbW = run + (margin * 2);
        const vbH = set + (margin * 2);

        // Asignar ViewBox para Zoom Automático
        svg.setAttribute("viewBox", `${vbX} ${vbY} ${vbW} ${vbH}`);

        // --- DIBUJO ---
        
        let defs = `<defs>
            <marker id="arrowHead" markerWidth="4" markerHeight="4" refX="0" refY="2" orient="auto" markerUnits="strokeWidth">
                <path d="M0,0 L0,4 L4,2 z" fill="#64748b" />
            </marker>
        </defs>`;
        svg.innerHTML += defs;

        // 1. Líneas Guía (Ejes)
        // Horizontal Inferior
        svg.innerHTML += `<line x1="${-20}" y1="0" x2="${run}" y2="0" stroke="#94a3b8" stroke-dasharray="10,5" vector-effect="non-scaling-stroke" stroke-width="1"/>`;
        // Vertical Derecha
        svg.innerHTML += `<line x1="${run}" y1="0" x2="${run}" y2="${-set}" stroke="#94a3b8" stroke-dasharray="10,5" vector-effect="non-scaling-stroke" stroke-width="1"/>`;
        // Diagonal (Travel)
        svg.innerHTML += `<line x1="0" y1="0" x2="${run}" y2="${-set}" stroke="#cbd5e1" stroke-dasharray="5,5" vector-effect="non-scaling-stroke" stroke-width="1"/>`;

        // 2. Tubería (Gruesa)
        // Grosor relativo al tamaño del dibujo para que no se vea ni muy fina ni muy gorda
        const pipeW = Math.max(run, set) * 0.02 + 2; 
        const pipeColor = (cut < 0) ? "#ef4444" : "#facc15"; // Rojo error, Amarillo ok
        
        // Camino simplificado (Visual)
        svg.innerHTML += `<path d="M ${-margin/2} 0 L 0 0 L ${run} ${-set} L ${run + margin/2} ${-set}" 
            fill="none" stroke="${pipeColor}" stroke-width="${pipeW}" stroke-linejoin="round" stroke-linecap="round"/>`;

        // 3. Cotas (Dimensiones) - Adaptadas
        const distCota = margin * 0.4;
        
        // Cota Avance (Abajo)
        svg.innerHTML += `<line x1="0" y1="${distCota}" x2="${run}" y2="${distCota}" stroke="#64748b" vector-effect="non-scaling-stroke" stroke-width="1.5" marker-end="url(#arrowHead)"/>`;
        svg.innerHTML += `<line x1="0" y1="${distCota}" x2="0" y2="0" stroke="#64748b" vector-effect="non-scaling-stroke" stroke-width="0.5"/>`;
        svg.innerHTML += `<line x1="${run}" y1="${distCota}" x2="${run}" y2="0" stroke="#64748b" vector-effect="non-scaling-stroke" stroke-width="0.5"/>`;
        
        // Texto Avance (Escalado para que no sea gigante ni diminuto)
        const textSize = Math.max(run, set) * 0.05 + 5; 
        svg.innerHTML += `<text x="${run/2}" y="${distCota + textSize}" fill="#475569" font-size="${textSize}" text-anchor="middle" font-weight="bold">AVANCE: ${run}</text>`;

        // Cota Altura (Derecha)
        svg.innerHTML += `<line x1="${run + distCota}" y1="0" x2="${run + distCota}" y2="${-set}" stroke="#64748b" vector-effect="non-scaling-stroke" stroke-width="1.5" marker-end="url(#arrowHead)"/>`;
        svg.innerHTML += `<line x1="${run + distCota}" y1="0" x2="${run}" y2="0" stroke="#64748b" vector-effect="non-scaling-stroke" stroke-width="0.5"/>`;
        svg.innerHTML += `<line x1="${run + distCota}" y1="${-set}" x2="${run}" y2="${-set}" stroke="#64748b" vector-effect="non-scaling-stroke" stroke-width="0.5"/>`;
        
        // Texto Altura (Rotado)
        svg.innerHTML += `<text x="${run + distCota + textSize}" y="${-set/2}" fill="#475569" font-size="${textSize}" text-anchor="middle" font-weight="bold" transform="rotate(-90, ${run + distCota + textSize}, ${-set/2})">ALTURA: ${set}</text>`;

        // 4. Ángulo
        if (run > 0 && set > 0) {
            svg.innerHTML += `<text x="${textSize*2}" y="${-textSize/2}" fill="#2563eb" font-size="${textSize}" font-weight="bold">${ang.toFixed(1)}°</text>`;
        }

        // 5. Etiqueta Corte
        if (cut > 0) {
            svg.innerHTML += `<text x="${run/2}" y="${-set/2 - textSize}" fill="#facc15" font-size="${textSize}" text-anchor="middle" font-weight="bold" stroke="#000" stroke-width="0.5" paint-order="stroke">CORTE = ${cut.toFixed(0)}</text>`;
        }
    }
    // --- OTROS CÁLCULOS (Bridas, Pesos, Codos, Eslingas) ---
    const dbB = { "150": { "2":{od:152.4,bc:120.7,h:4,w:27}, "4":{od:228.6,bc:190.5,h:8,w:27} }, "300": { "4":{od:254,bc:200.2,h:8,w:32} } };
    function getBrida() {
        let s = document.getElementById('brSize').value, c = document.getElementById('brClass').value, d = dbB[c][s];
        if(!d) return;
        document.getElementById('brRes').style.display='block';
        document.getElementById('brOD').innerText = d.od; document.getElementById('brBC').innerText = d.bc;
        document.getElementById('brH').innerText = d.h; document.getElementById('brW').innerText = d.w;
    }

    function calcPeso() {
        let l = parseFloat(document.getElementById('pL').value);
        document.getElementById('resP').style.display = 'block';
        document.getElementById('resPVal').innerText = (16.1 * l).toFixed(1) + " Kg";
    }

    function calcCo() {
        let d = parseFloat(document.getElementById('coD').value), a = parseFloat(document.getElementById('coA').value);
        if(!d || !a) return;
        let r = (coType === 'LR' ? d * 38.1 : d * 25.4);
        document.getElementById('resCo').style.display = 'block';
        document.getElementById('resCoVal').innerText = (r * Math.tan((a/2) * Math.PI / 180)).toFixed(1) + " mm";
    }

    const slings = [{c:'#7c3aed', n:'VIOLETA', t:1}, {c:'#16a34a', n:'VERDE', t:2}, {c:'#facc15', n:'AMARILLO', t:3}, {c:'#dc2626', n:'ROJO', t:5}, {c:'#2563eb', n:'AZUL', t:8}];
    let sHtml = '';
    slings.forEach(s => { sHtml += `<div class="sling-row"><div style="width:35px;height:35px;border-radius:10px;background:${s.c}"></div><div style="flex:1;font-weight:800;font-size:0.7rem;color:#475569;">${s.n}</div><div style="font-size:1.3rem;font-weight:900;color:#1e293b;">${s.t} T</div></div>`; });
    document.getElementById('slingList').innerHTML = sHtml;
</script>
</body>
</html> 






