<script>
    // --- LÓGICA DE INICIO (SPLASH) ---
    window.addEventListener('load', () => {
        setTimeout(() => {
            const splash = document.getElementById('splash-screen');
            splash.style.opacity = '0';
            setTimeout(() => { splash.style.display = 'none'; }, 800);
        }, 3000); 
    });

    // Variables Globales
    let unitBP = 'in', divBP = 16, exportFormat = 'a4', coType = 'LR';
    // Guardamos datos extendidos para poder recalcular en alta resolución
    let lastBP = { 
        pts: [], per: 0, r: 0, c: 0, 
        R_cab_mm: 0, r_ram_mm: 0, angRad: 0, 
        unit: 'in', paso: 0, angle: 90, margin: 0,
        minY_raw: 0 
    };

    function showMsg(text) {
        const box = document.getElementById('ui-message');
        box.innerText = text; box.style.display = 'block';
        setTimeout(() => { box.style.display = 'none'; }, 3000);
    }

    function setTab(id, btn) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    function setFormat(f) {
        exportFormat = f;
        document.getElementById('formatA4').classList.toggle('active', f==='a4');
        document.getElementById('formatA3').classList.toggle('active', f==='a3');
    }

    function getOD(inch) {
        const m = {"2":60.3, "3":88.9, "4":114.3, "6":168.3, "8":219.1, "10":273.0, "12":323.8, "14":355.6, "16":406.4};
        return m[inch] || inch * 25.4;
    }

    // Helpers UI
    function setUn(u) { unitBP = u; document.getElementById('unIn').classList.toggle('active', u==='in'); document.getElementById('unMm').classList.toggle('active', u==='mm'); }
    function setDiv(d) { divBP = d; document.getElementById('div8').classList.toggle('active', d===8); document.getElementById('div16').classList.toggle('active', d===16); }
    function setCo(t) { coType = t; document.getElementById('coLR').classList.toggle('active', t==='LR'); document.getElementById('coSR').classList.toggle('active', t==='SR'); }

    // ==========================================
    // --- 1. MÓDULO BOCA DE PEZ (MEJORADO) ---
    // ==========================================
    function calcBP() {
        let cIn = parseFloat(document.getElementById('bpC').value);
        let rIn = parseFloat(document.getElementById('bpR').value);
        let ang = parseFloat(document.getElementById('bpAng').value);
        let marg = document.getElementById('bpMarg').checked ? 30 : 10; 

        if(!cIn || !rIn || !ang) { showMsg("Faltan datos"); return; }

        let R_cab = (unitBP === 'in' ? getOD(cIn) : cIn) / 2;
        let r_ram = (unitBP === 'in' ? getOD(rIn) : rIn) / 2;
        let angRad = ang * Math.PI / 180;
        
        if(r_ram > R_cab) { showMsg("Error: Ramal > Cabezal"); return; }

        let per = (r_ram * 2) * Math.PI;
        let paso = per / divBP;
        
        // --- CÁLCULO PARA TABLA (Baja Resolución) ---
        let rawPts = [];
        for(let i=0; i<=divBP; i++){
            let phi = (i * 360 / divBP) * Math.PI / 180;
            let y = (Math.sqrt(Math.pow(R_cab, 2) - Math.pow(r_ram * Math.sin(phi), 2)) / Math.sin(angRad)) - (r_ram * Math.cos(phi) / Math.tan(angRad));
            rawPts.push(y);
        }

        // Normalizar alturas
        let minY = Math.min(...rawPts);
        let finalPts = rawPts.map(y => (y - minY) + marg);
        
        // Guardar estado global COMPLETO
        lastBP = { 
            per: per, 
            r: rIn, c: cIn, 
            pts: finalPts, 
            unit: unitBP, 
            paso: paso, 
            angle: ang,
            margin: marg,
            R_cab_mm: R_cab,
            r_ram_mm: r_ram,
            angRad: angRad,
            minY_raw: minY 
        };
        
        // Renderizar tabla
        let tbody = document.querySelector("#tableBP tbody");
        tbody.innerHTML = "";
        lastBP.pts.forEach((p, i) => { 
            tbody.innerHTML += `<tr><td>${i}</td><td>${(i*360/divBP).toFixed(0)}°</td><td>${p.toFixed(1)}</td></tr>`; 
        });
        
        document.getElementById('resBP').style.display = 'block';
        document.getElementById('bpPer').innerText = per.toFixed(1) + " mm";
        document.getElementById('bpPas').innerText = paso.toFixed(1) + " mm";
        
        drawJointSvg(R_cab, r_ram, ang);
        drawTemplateSvg();
    }

    function drawTemplateSvg() {
        let svg = document.getElementById('bpSvg');
        let w = 400; let h = 160; 
        let step = w / (lastBP.pts.length - 1);
        let maxVal = Math.max(...lastBP.pts);
        let scY = (h - 20) / (maxVal || 1); 

        let path = `M 0 ${h}`; 
        lastBP.pts.forEach((p, i) => {
            let px = i * step;
            let py = h - (p * scY); 
            path += ` L ${px} ${py}`;
        });
        path += ` L 400 ${h} Z`; 

        let fajaY = h - (lastBP.margin * scY);
        let fajaLine = `<line x1="0" y1="${fajaY}" x2="400" y2="${fajaY}" stroke="#facc15" stroke-dasharray="4"/>`;

        svg.innerHTML = `<rect width="400" height="160" fill="#0f172a"/>
                         ${fajaLine}
                         <path d="${path}" stroke="var(--blue-pro)" stroke-width="2" fill="rgba(2, 132, 199, 0.2)" stroke-linejoin="round"/>`;
    }

    // ==============================================================
    // --- 2. EXPORTACIÓN PDF (PERFILADO COMPLETO + CURVA HD) ---
    // ==============================================================
    function pdfMultiPaginado() {
        if(!lastBP.pts.length) return;
        const overlay = document.getElementById('loading-overlay');
        overlay.style.display = 'flex';
        
        setTimeout(() => {
            try {
                const { jsPDF } = window.jspdf;
                const isA3 = (exportFormat === 'a3');
                const pW = isA3 ? 420 : 297; 
                const pH = isA3 ? 297 : 210; 
                const margin = 20; 
                const drawableW = pW - (margin * 2);
                
                const numPages = Math.ceil(lastBP.per / drawableW);
                const doc = new jsPDF({ orientation: 'l', unit: 'mm', format: exportFormat });

                // Generar 360 puntos HD
                const hdSteps = 360; 
                let hdPoints = [];
                for(let i=0; i<=hdSteps; i++) {
                    let phi = (i * 360 / hdSteps) * Math.PI / 180;
                    let y = (Math.sqrt(Math.pow(lastBP.R_cab_mm, 2) - Math.pow(lastBP.r_ram_mm * Math.sin(phi), 2)) / Math.sin(lastBP.angRad)) - (lastBP.r_ram_mm * Math.cos(phi) / Math.tan(lastBP.angRad));
                    let finalY = (y - lastBP.minY_raw) + lastBP.margin;
                    let finalX = (i / hdSteps) * lastBP.per;
                    hdPoints.push({x: finalX, y: finalY});
                }

                for (let p = 0; p < numPages; p++) {
                    if (p > 0) doc.addPage();
                    
                    // Cabecera
                    doc.setFontSize(14); doc.setTextColor(0,0,0);
                    doc.text(`PLANTILLA 1:1 - XURXO (${exportFormat.toUpperCase()}) - PÁG ${p+1}/${numPages}`, margin, 15);
                    doc.setFontSize(10); doc.setTextColor(100);
                    doc.text(`Ramal: ${lastBP.r}" | Ángulo: ${lastBP.angle}° | Perímetro: ${lastBP.per.toFixed(1)}mm`, margin, 22);
                    
                    doc.setDrawColor(220, 38, 38); doc.setLineWidth(0.5);
                    doc.line(margin, 30, margin + 100, 30);
                    doc.line(margin, 28, margin, 32); doc.line(margin+100, 28, margin+100, 32);
                    doc.setTextColor(220, 38, 38); doc.setFontSize(8);
                    doc.text("VERIFICAR ESCALA: 100mm", margin + 25, 29);

                    // Coordenadas
                    const startX_Abs = p * drawableW; 
                    const endX_Abs = (p + 1) * drawableW;
                    const yBase = 180; // Suelo de la plantilla en el papel

                    // 1. DIBUJAR PERFILADO (CONTORNO DE RECORTE)
                    doc.setDrawColor(0); doc.setLineWidth(0.6); // Línea gruesa para cortar

                    // A. Lateral Izquierdo (Vertical hacia arriba)
                    // Buscamos altura inicial en este tramo
                    let firstPtHeight = getInterpHeight(startX_Abs, hdPoints);
                    doc.line(margin, yBase, margin, yBase - firstPtHeight);

                    // B. Curva Superior (HD)
                    // Dibujamos solo el tramo correspondiente a esta página
                    let pointsInPage = [];
                    // Añadimos punto inicial exacto
                    pointsInPage.push({x: startX_Abs, y: firstPtHeight});

                    // Añadimos puntos intermedios
                    for (let pt of hdPoints) {
                        if(pt.x > startX_Abs && pt.x < endX_Abs) {
                            pointsInPage.push(pt);
                        }
                    }

                    // Añadimos punto final exacto
                    let lastPtHeight = getInterpHeight(Math.min(endX_Abs, lastBP.per), hdPoints);
                    pointsInPage.push({x: Math.min(endX_Abs, lastBP.per), y: lastPtHeight});

                    // Trazar curva
                    for(let i=0; i<pointsInPage.length-1; i++){
                        let p1 = pointsInPage[i];
                        let p2 = pointsInPage[i+1];
                        let x1 = (p1.x - startX_Abs) + margin;
                        let y1 = yBase - p1.y;
                        let x2 = (p2.x - startX_Abs) + margin;
                        let y2 = yBase - p2.y;
                        doc.line(x1, y1, x2, y2);
                    }

                    // C. Lateral Derecho (Vertical hacia abajo)
                    // Si es la última página, la línea va en el final del perímetro, no al final de la hoja
                    let rightEdgeX = (Math.min(endX_Abs, lastBP.per) - startX_Abs) + margin;
                    let rightEdgeHeight = lastPtHeight;
                    doc.line(rightEdgeX, yBase - rightEdgeHeight, rightEdgeX, yBase);

                    // D. Base Inferior (Cierre del rectángulo)
                    doc.line(rightEdgeX, yBase, margin, yBase);
                    
                    // Texto "RECORTAR POR LA LÍNEA"
                    doc.setFontSize(8); doc.setTextColor(150);
                    doc.text("LÍNEA DE CORTE (PERFILADO)", margin + 5, yBase + 4);

                    // 2. LÍNEA DE REFERENCIA DE FAJA (Discontinua Naranja)
                    const fajaY = yBase - lastBP.margin;
                    doc.setDrawColor(255, 140, 0); doc.setLineWidth(0.3); doc.setLineDash([3, 2], 0);
                    doc.line(margin, fajaY, rightEdgeX, fajaY);
                    doc.setTextColor(255, 140, 0);
                    doc.text(`DOBLAR/REFERENCIA (${lastBP.margin}mm)`, margin + 5, fajaY - 2);
                    
                    // Reset estilos
                    doc.setLineDash([], 0);

                    // 3. Ejes verticales
                    const quadrantStep = lastBP.per / 4;
                    for(let q=0; q<=4; q++) {
                        let qX = q * quadrantStep;
                        if(qX >= startX_Abs && qX <= endX_Abs) {
                            let plotX = (qX - startX_Abs) + margin;
                            doc.setDrawColor(200); doc.setLineWidth(0.2);
                            doc.line(plotX, yBase, plotX, yBase - 150); 
                            doc.setFontSize(8); doc.setTextColor(100);
                            doc.text(`${q*90}°`, plotX + 1, yBase - 5);
                        }
                    }
                }
                doc.save(`Plantilla_Corte_Xurxo_${lastBP.r}.pdf`);

            } catch (err) { console.error(err); showMsg("Error PDF"); }
            overlay.style.display = 'none';
        }, 1000);
    }

    // Helper para interpolar altura exacta en cortes de página
    function getInterpHeight(targetX, points) {
        // Encontrar los dos puntos más cercanos
        for(let i=0; i<points.length-1; i++) {
            if(points[i].x <= targetX && points[i+1].x >= targetX) {
                let p1 = points[i];
                let p2 = points[i+1];
                // Regla de tres simple (Interpolación lineal)
                let ratio = (targetX - p1.x) / (p2.x - p1.x);
                if(isNaN(ratio)) ratio = 0; // Evitar div/0
                return p1.y + (p2.y - p1.y) * ratio;
            }
        }
        return points[points.length-1].y; // Fallback final
    }

    async function pdfInforme() {
        if(!lastBP.pts.length) return;
        const overlay = document.getElementById('loading-overlay');
        overlay.style.display = 'flex';
        try {
            document.getElementById('nav-ignore').style.display = 'none';
            document.getElementById('form-ignore').style.display = 'none';
            document.getElementById('btns-ignore').style.display = 'none';
            const canvas = await html2canvas(document.getElementById('capture-area'), { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            pdf.setFontSize(18); pdf.text("INFORME TÉCNICO - XURXO", 105, 15, { align: 'center' });
            pdf.addImage(imgData, 'PNG', 10, 25, 190, (canvas.height * 190) / canvas.width);
            pdf.save(`Informe_Xurxo_${lastBP.r}.pdf`);
        } finally {
            document.getElementById('nav-ignore').style.display = 'grid';
            document.getElementById('form-ignore').style.display = 'block';
            document.getElementById('btns-ignore').style.display = 'block';
            overlay.style.display = 'none';
        }
    }


    // ==========================================
    // --- 3. MÓDULO BAYONETA (RESPONSIVE) ---
    // ==========================================
    let byType = 'LR'; 
    let byUnitDia = 'in';

    function setByRad(t) {
        byType = t;
        document.getElementById('byLR').classList.toggle('active', t === 'LR');
        document.getElementById('bySR').classList.toggle('active', t === 'SR');
    }

    function toggleDiaUnit(u) {
        byUnitDia = u;
        document.getElementById('btnDiaIn').classList.toggle('active', u === 'in');
        document.getElementById('btnDiaMm').classList.toggle('active', u === 'mm');
        document.getElementById('inputDiaIn').style.display = (u === 'in') ? 'block' : 'none';
        document.getElementById('inputDiaMm').style.display = (u === 'mm') ? 'block' : 'none';
    }

    function calcBayonetaPro() {
        const run = parseFloat(document.getElementById('byRun').value);
        const set = parseFloat(document.getElementById('bySet').value);
        
        let diameterBase = 0;
        if (byUnitDia === 'in') {
            diameterBase = parseFloat(document.getElementById('byDiaSel').value) * 25.4; 
        } else {
            diameterBase = parseFloat(document.getElementById('byDiaInp').value); 
        }
        
        if (!run || !set || !diameterBase) { showMsg("Faltan datos"); return; }

        const travel = Math.sqrt(Math.pow(run, 2) + Math.pow(set, 2));
        const angleRad = Math.atan(set / run);
        const angleDeg = angleRad * (180 / Math.PI);

        const radius = (byType === 'LR') ? (diameterBase * 1.5) : (diameterBase * 1.0);
        
        const elbowAdv = radius * Math.tan(angleRad / 2);
        const totalDeduct = elbowAdv * 2; 
        const cutLength = travel - totalDeduct;

        document.getElementById('resByPro').style.display = 'block';
        document.getElementById('outByAng').innerText = angleDeg.toFixed(1) + "°";
        document.getElementById('outByTrav').innerText = travel.toFixed(1) + " mm";
        document.getElementById('outByDesc').innerText = "-" + totalDeduct.toFixed(1) + " mm";
        
        const cutElem = document.getElementById('outByCut');
        if (cutLength < 0) {
            cutElem.innerText = "IMPOSIBLE";
            cutElem.style.color = "red";
            showMsg("¡Cuidado! Solape.");
        } else {
            cutElem.innerText = cutLength.toFixed(1) + " mm";
            cutElem.style.color = "#15803d";
        }

        drawBayonetaSvgResponsive(run, set, cutLength, angleDeg);
    }

    function drawBayonetaSvgResponsive(run, set, cut, ang) {
        const svg = document.getElementById('bySvg');
        svg.innerHTML = ''; 

        const margin = Math.max(run, set) * 0.15 + 40; 
        
        const vbX = -margin;
        const vbY = -set - margin; 
        const vbW = run + (margin * 2);
        const vbH = set + (margin * 2);

        svg.setAttribute("viewBox", `${vbX} ${vbY} ${vbW} ${vbH}`);

        let defs = `<defs>
            <marker id="arrowHead" markerWidth="4" markerHeight="4" refX="0" refY="2" orient="auto" markerUnits="strokeWidth">
                <path d="M0,0 L0,4 L4,2 z" fill="#64748b" />
            </marker>
        </defs>`;
        svg.innerHTML += defs;

        // Guías
        svg.innerHTML += `<line x1="${-20}" y1="0" x2="${run}" y2="0" stroke="#94a3b8" stroke-dasharray="10,5" vector-effect="non-scaling-stroke" stroke-width="1"/>`;
        svg.innerHTML += `<line x1="${run}" y1="0" x2="${run}" y2="${-set}" stroke="#94a3b8" stroke-dasharray="10,5" vector-effect="non-scaling-stroke" stroke-width="1"/>`;
        svg.innerHTML += `<line x1="0" y1="0" x2="${run}" y2="${-set}" stroke="#cbd5e1" stroke-dasharray="5,5" vector-effect="non-scaling-stroke" stroke-width="1"/>`;

        // Tubo
        const pipeW = Math.max(run, set) * 0.02 + 2; 
        const pipeColor = (cut < 0) ? "#ef4444" : "#facc15"; 
        
        svg.innerHTML += `<path d="M ${-margin/2} 0 L 0 0 L ${run} ${-set} L ${run + margin/2} ${-set}" 
            fill="none" stroke="${pipeColor}" stroke-width="${pipeW}" stroke-linejoin="round" stroke-linecap="round"/>`;

        // Cotas
        const distCota = margin * 0.4;
        const textSize = Math.max(run, set) * 0.05 + 5; 

        // Avance
        svg.innerHTML += `<line x1="0" y1="${distCota}" x2="${run}" y2="${distCota}" stroke="#64748b" vector-effect="non-scaling-stroke" stroke-width="1.5" marker-end="url(#arrowHead)"/>`;
        svg.innerHTML += `<line x1="0" y1="${distCota}" x2="0" y2="0" stroke="#64748b" vector-effect="non-scaling-stroke" stroke-width="0.5"/>`;
        svg.innerHTML += `<line x1="${run}" y1="${distCota}" x2="${run}" y2="0" stroke="#64748b" vector-effect="non-scaling-stroke" stroke-width="0.5"/>`;
        svg.innerHTML += `<text x="${run/2}" y="${distCota + textSize}" fill="#475569" font-size="${textSize}" text-anchor="middle" font-weight="bold">AVANCE: ${run}</text>`;

        // Altura
        svg.innerHTML += `<line x1="${run + distCota}" y1="0" x2="${run + distCota}" y2="${-set}" stroke="#64748b" vector-effect="non-scaling-stroke" stroke-width="1.5" marker-end="url(#arrowHead)"/>`;
        svg.innerHTML += `<line x1="${run + distCota}" y1="0" x2="${run}" y2="0" stroke="#64748b" vector-effect="non-scaling-stroke" stroke-width="0.5"/>`;
        svg.innerHTML += `<line x1="${run + distCota}" y1="${-set}" x2="${run}" y2="${-set}" stroke="#64748b" vector-effect="non-scaling-stroke" stroke-width="0.5"/>`;
        svg.innerHTML += `<text x="${run + distCota + textSize}" y="${-set/2}" fill="#475569" font-size="${textSize}" text-anchor="middle" font-weight="bold" transform="rotate(-90, ${run + distCota + textSize}, ${-set/2})">ALTURA: ${set}</text>`;

        if (run > 0 && set > 0) {
            svg.innerHTML += `<text x="${textSize*2}" y="${-textSize/2}" fill="#2563eb" font-size="${textSize}" font-weight="bold">${ang.toFixed(1)}°</text>`;
        }
        if (cut > 0) {
            svg.innerHTML += `<text x="${run/2}" y="${-set/2 - textSize}" fill="#facc15" font-size="${textSize}" text-anchor="middle" font-weight="bold" stroke="#000" stroke-width="0.5" paint-order="stroke">CORTE = ${cut.toFixed(0)}</text>`;
        }
    }
    
    function drawJointSvg(R, r, ang) {
        const svg = document.getElementById('jointSvg');
        const angRad = ang * Math.PI / 180;
        const scale = 110 / (R * 2);
        const scR = R * scale, scr = r * scale;
        const cx = 150, cy = 200, L = 160;
        const vx = Math.cos(angRad), vy = -Math.sin(angRad);
        
        let content = `<rect width="400" height="300" fill="#0f172a"/>`;
        content += `<rect x="40" y="${cy - scR}" width="320" height="${scR * 2}" fill="none" stroke="#475569" stroke-width="2" rx="2"/>`;
        content += `<line x1="30" y1="${cy}" x2="370" y2="${cy}" stroke="#334155" stroke-dasharray="10,5,2,5"/>`;
        const x1 = cx - scr * Math.sin(angRad), y1 = cy - scR - scr * Math.cos(angRad);
        const x2 = cx + scr * Math.sin(angRad), y2 = cy - scR + scr * Math.cos(angRad);
        content += `<line x1="${x1}" y1="${y1}" x2="${x1 + L * vx}" y2="${y1 + L * vy}" stroke="white" stroke-width="2.5"/>`;
        content += `<line x1="${x2}" y1="${y2}" x2="${x2 + L * vx}" y2="${y2 + L * vy}" stroke="white" stroke-width="2.5"/>`;
        content += `<text x="${cx + 40}" y="${cy - scR - 20}" fill="var(--accent)" font-size="18" font-weight="black">${ang}°</text>`;
        svg.innerHTML = content;
    }

    // --- OTROS CÁLCULOS ---
    const dbB = { "150": { "2":{od:152.4,bc:120.7,h:4,w:27}, "4":{od:228.6,bc:190.5,h:8,w:27} }, "300": { "4":{od:254,bc:200.2,h:8,w:32} } };
    function getBrida() {
        let s = document.getElementById('brSize').value, c = document.getElementById('brClass').value, d = dbB[c][s];
        if(!d) return;
        document.getElementById('brRes').style.display='block';
        document.getElementById('brOD').innerText = d.od; document.getElementById('brBC').innerText = d.bc;
        document.getElementById('brH').innerText = d.h; document.getElementById('brW').innerText = d.w;
    }

    function calcPeso() {
        let l = parseFloat(document.getElementById('pL').value);
        document.getElementById('resP').style.display = 'block';
        document.getElementById('resPVal').innerText = (16.1 * l).toFixed(1) + " Kg";
    }

    function calcCo() {
        let d = parseFloat(document.getElementById('coD').value), a = parseFloat(document.getElementById('coA').value);
        if(!d || !a) return;
        let r = (coType === 'LR' ? d * 38.1 : d * 25.4);
        document.getElementById('resCo').style.display = 'block';
        document.getElementById('resCoVal').innerText = (r * Math.tan((a/2) * Math.PI / 180)).toFixed(1) + " mm";
    }

    const slings = [{c:'#7c3aed', n:'VIOLETA', t:1}, {c:'#16a34a', n:'VERDE', t:2}, {c:'#facc15', n:'AMARILLO', t:3}, {c:'#dc2626', n:'ROJO', t:5}, {c:'#2563eb', n:'AZUL', t:8}];
    let sHtml = '';
    slings.forEach(s => { sHtml += `<div class="sling-row"><div style="width:35px;height:35px;border-radius:10px;background:${s.c}"></div><div style="flex:1;font-weight:800;font-size:0.7rem;color:#475569;">${s.n}</div><div style="font-size:1.3rem;font-weight:900;color:#1e293b;">${s.t} T</div></div>`; });
    document.getElementById('slingList').innerHTML = sHtml;
</script>
