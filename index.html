<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XURXO - Tubero Pro Elite v25.0 (ISO TÉCNICO)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-body: #0f172a;
            --primary: #1e293b;
            --accent: #f59e0b;
            --blue-pro: #38bdf8;
            --text-main: #cbd5e1;
            --workshop-green: #4ade80;
            --pdf-red: #ef4444;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            padding: 10px;
            display: flex;
            justify-content: center;
            overflow-x: hidden;
        }

        /* --- PANTALLA DE INICIO --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #1e293b 0%, #0f172a 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10000; transition: opacity 0.8s ease;
            color: white; text-align: center;
        }
        .splash-logo { font-size: 3rem; font-weight: 900; letter-spacing: 5px; color: var(--accent); text-shadow: 0 0 20px rgba(245, 158, 11, 0.4); margin-bottom: 10px; }
        .splash-name { font-size: 1.2rem; font-weight: 300; letter-spacing: 3px; text-transform: uppercase; }
        .splash-version { margin-top: 30px; font-family: monospace; color: #64748b; font-size: 0.8rem; }

        /* --- APP CONTAINER --- */
        .app-container {
            width: 100%; max-width: 500px;
            background: #1e293b; /* Fondo oscuro pro */
            min-height: 98vh; border-radius: 20px;
            overflow: hidden; display: flex; flex-direction: column;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5); position: relative;
            border: 1px solid #334155;
        }

        header {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white; padding: 25px 15px; text-align: center;
            border-bottom: 2px solid var(--accent);
        }

        .owner-badge {
            background: var(--accent); color: #000; padding: 4px 15px;
            border-radius: 50px; font-size: 0.75rem; font-weight: 800;
            display: inline-block; margin-top: 8px; text-transform: uppercase;
        }

        #ui-message {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: var(--pdf-red); color: white; padding: 12px 20px;
            border-radius: 10px; font-size: 0.85rem; font-weight: bold;
            z-index: 10000; display: none; width: 90%; text-align: center;
        }

        .nav-tabs { display: grid; grid-template-columns: repeat(3, 1fr); background: #0f172a; gap: 1px; border-bottom: 1px solid #334155; }
        .tab-btn {
            background: #1e293b; border: none; color: #64748b; padding: 15px 5px;
            cursor: pointer; display: flex; flex-direction: column; align-items: center;
            font-size: 0.65rem; font-weight: 700; text-transform: uppercase; transition: 0.3s;
        }
        .tab-btn svg { width: 20px; height: 20px; fill: currentColor; margin-bottom: 4px; }
        .tab-btn.active { color: var(--accent); background: #334155; border-bottom: 3px solid var(--accent); }

        .main-content { flex: 1; padding: 15px; overflow-y: auto; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { font-size: 1.1rem; color: white; margin-bottom: 15px; border-left: 4px solid var(--accent); padding-left: 10px; }

        .card {
            background: #334155; border-radius: 15px; padding: 15px;
            margin-bottom: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2);
            border: 1px solid #475569;
        }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.7rem; font-weight: 700; color: #94a3b8; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .input-group input, .input-group select {
            width: 100%; padding: 12px; background: #1e293b; border: 2px solid #475569;
            border-radius: 10px; font-size: 1rem; font-weight: 600; color: white;
            transition: 0.3s;
        }
        .input-group input:focus { border-color: var(--blue-pro); outline: none; }

        .btn-main {
            background: var(--blue-pro); color: #0f172a; border: none; width: 100%;
            padding: 15px; border-radius: 12px; font-weight: 800; text-transform: uppercase;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3); transition: transform 0.2s;
        }
        .btn-main:active { transform: scale(0.98); }

        .canvas-wrap {
            background: #0f172a; border-radius: 15px; margin-top: 15px; padding: 10px;
            overflow: hidden; border: 1px solid #475569; position: relative;
        }
        .canvas-label {
            position: absolute; top: 10px; left: 10px; font-size: 0.65rem; color: #64748b;
            font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
            background: rgba(15, 23, 42, 0.8); padding: 2px 6px; border-radius: 4px; pointer-events: none;
        }

        .radio-group { display: flex; gap: 8px; }
        .radio-btn {
            flex: 1; padding: 12px; background: #475569; border-radius: 10px; text-align: center;
            font-size: 0.8rem; font-weight: 700; cursor: pointer; color: #cbd5e1;
        }
        .radio-btn.active { background: var(--blue-pro); color: #0f172a; }

        #loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95);
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white;
            text-align: center; padding: 20px;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #334155; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; color: #e2e8f0; }
        .data-table th { background: #0f172a; padding: 10px; text-align: center; border-bottom: 2px solid #334155; }
        .data-table td { border-bottom: 1px solid #334155; padding: 10px; text-align: center; font-weight: 600; }
        
        .sling-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; background: #334155; padding: 12px; border-radius: 12px; border: 1px solid #475569; }
        
        /* Checkbox switch pro */
        .switch-wrap { display: flex; align-items: center; justify-content: space-between; background: rgba(56, 189, 248, 0.1); padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(56, 189, 248, 0.3); cursor: pointer; }
        .switch-label { font-weight: 800; color: var(--blue-pro); font-size: 0.8rem; text-transform: uppercase; }
        .switch-checkbox { width: 24px; height: 24px; accent-color: var(--blue-pro); }

        .btn-mini { padding: 6px 12px; font-size: 0.7rem; border-radius: 6px; background: #475569; color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-mini.active { background: var(--accent); color: black; }
    </style>
</head>
<body>

<div id="splash-screen">
    <div class="splash-logo">TUBERO PRO</div>
    <div class="splash-name">OFICIAL: XURXO</div>
    <div class="splash-version">BUILD 2024 - v25.0 ISO TÉCNICO</div>
</div>

<div id="ui-message">Aviso</div>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 10px;">GENERANDO DOCUMENTOS</div>
</div>

<div class="app-container" id="capture-area">
    <header>
        <h1>TUBERO PRO</h1>
        <div class="owner-badge">OFICIAL: XURXO</div>
    </header>

    <nav class="nav-tabs" id="nav-ignore">
        <button class="tab-btn active" onclick="setTab('tab-bocapez', this)"><svg viewBox="0 0 24 24"><path d="M12,2L4.5,20.29L5.21,21L12,18L18.79,21L19.5,20.29L12,2Z"/></svg>Boca Pez</button>
        <button class="tab-btn" onclick="setTab('tab-bayoneta', this)"><svg viewBox="0 0 24 24"><path d="M21,16.5L12,21.5L3,16.5V7.5L12,2.5L21,7.5V16.5Z"/></svg>Bayoneta</button>
        <button class="tab-btn" onclick="setTab('tab-bridas', this)"><svg viewBox="0 0 24 24"><path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5Z"/></svg>Bridas</button>
        <button class="tab-btn" onclick="setTab('tab-pesos', this)"><svg viewBox="0 0 24 24"><path d="M12,3L1,9L12,15L21,10V17H23V9M5,13V17L12,21L19,17V13L12,17L5,13Z"/></svg>Pesos</button>
        <button class="tab-btn" onclick="setTab('tab-codos', this)"><svg viewBox="0 0 24 24"><path d="M19,15V19H5V5H9V3H5C3.9,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V15H19M16,3H21V8H19V6.4L11.9,13.5L10.5,12.1L17.6,5H16V3Z"/></svg>Codos</button>
        <button class="tab-btn" onclick="setTab('tab-cargas', this)"><svg viewBox="0 0 24 24"><path d="M13,10H18L12,16L6,10H11V3H13V10M4,19H20V21H4V19Z"/></svg>Izaje</button>
    </nav>

    <div class="main-content">
        
        <div id="tab-bocapez" class="section active">
            <h2>Injerto Boca de Pez (Ángulo Variable)</h2>
            <div class="card" id="form-ignore">
                <div class="input-group">
                    <label>Unidades</label>
                    <div class="radio-group">
                        <div class="radio-btn active" id="unIn" onclick="setUn('in')">Pulgadas</div>
                        <div class="radio-btn" id="unMm" onclick="setUn('mm')">mm</div>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                    <div class="input-group"><label>Cabezal (OD)</label><input type="number" id="bpC" placeholder="6"></div>
                    <div class="input-group"><label>Ramal (OD)</label><input type="number" id="bpR" placeholder="4"></div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                    <div class="input-group"><label>Ángulo Inclinación (°)</label><input type="number" id="bpAng" value="90"></div>
                    <div class="input-group">
                        <label>Divisiones</label>
                        <div class="radio-group">
                            <div class="radio-btn active" id="div8" onclick="setDiv(8)">8</div>
                            <div class="radio-btn" id="div16" onclick="setDiv(16)">16</div>
                        </div>
                    </div>
                </div>
                <label style="display:flex; align-items:center; gap:10px; font-size:0.85rem; background:rgba(245, 158, 11, 0.1); padding:12px; border-radius:10px; border:1px solid rgba(245, 158, 11, 0.3); color:var(--accent); cursor:pointer;">
                    <input type="checkbox" id="bpMarg" style="width:18px; height:18px;"> +30mm Faja de Papel
                </label>
                <button class="btn-main" style="margin-top:15px;" onclick="calcBP()">Generar Informe y Trazado</button>
            </div>

            <div id="resBP" style="display:none">
                <div class="canvas-wrap">
                    <div class="canvas-label">Vista Técnica de Montaje</div>
                    <svg id="jointSvg" viewBox="0 0 400 300" style="background: #0f172a;"></svg>
                </div>

                <div style="background:rgba(56, 189, 248, 0.1); padding:15px; border-radius:15px; margin-bottom:15px; border:1px solid var(--blue-pro); display:flex; justify-content: space-around; text-align: center; margin-top: 15px;">
                    <div><div style="font-size:0.65rem; color:var(--blue-pro); font-weight:800;">PERÍMETRO</div><div id="bpPer" style="font-size:1.1rem; font-weight:900; color:white;">0</div></div>
                    <div style="width:1px; background:#475569;"></div>
                    <div><div style="font-size:0.65rem; color:var(--blue-pro); font-weight:800;">PASO</div><div id="bpPas" style="font-size:1.1rem; font-weight:900; color:white;">0</div></div>
                </div>
                
                <div class="card" id="btns-ignore">
                    <div class="input-group">
                        <label>Formato de Papel (1:1)</label>
                        <div class="radio-group">
                            <div class="radio-btn active" id="formatA4" onclick="setFormat('a4')">A4 Apaisado</div>
                            <div class="radio-btn" id="formatA3" onclick="setFormat('a3')">Plano A3</div>
                        </div>
                    </div>
                    <button class="btn-main" style="background:var(--workshop-green); color:#064e3b;" onclick="pdfMultiPaginado()">
                        EXPORTAR PLANTILLA 1:1 (HD)
                    </button>
                    <button class="btn-main" style="background:var(--pdf-red); color:white; margin-top:8px;" onclick="pdfInforme()">
                        EXPORTAR FICHA TÉCNICA
                    </button>
                </div>

                <div class="card" style="padding:0; overflow:hidden;">
                    <table class="data-table" id="tableBP">
                        <thead><tr><th>PTO</th><th>GRAD</th><th>ORD (mm)</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="canvas-wrap">
                    <div class="canvas-label">Plantilla para Corte</div>
                    <svg id="bpSvg" viewBox="0 0 400 160"></svg>
                </div>
            </div>
        </div>

        <div id="tab-bayoneta" class="section">
            <h2>Cálculo de Bayonetas (ISO)</h2>
            <div class="card">
                
                <label class="switch-wrap">
                    <span class="switch-label">ACTIVAR GIRADA (3D / ROLLING)</span>
                    <input type="checkbox" id="checkRolling" class="switch-checkbox" onchange="toggleRoll()">
                </label>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                    <div class="input-group">
                        <label style="color:var(--blue-pro);">Avance (Run)</label>
                        <input type="number" id="byRun" placeholder="mm" style="border-color:var(--blue-pro);">
                    </div>
                    <div class="input-group">
                        <label style="color:var(--pdf-red);">Altura (Set)</label> 
                        <input type="number" id="bySet" placeholder="mm" style="border-color:var(--pdf-red);">
                    </div>
                </div>

                <div class="input-group" id="groupRoll" style="display:none; background:rgba(74, 222, 128, 0.1); padding:10px; border-radius:10px; border:1px solid var(--workshop-green);">
                    <label style="color:var(--workshop-green);">Desplazamiento (Roll)</label>
                    <input type="number" id="byRoll" placeholder="mm" style="border-color:var(--workshop-green);">
                </div>

                <div class="input-group">
                    <label>Unidad Diámetro</label>
                    <div class="radio-group" style="margin-bottom:10px;">
                        <div class="radio-btn active" id="btnDiaIn" onclick="toggleDiaUnit('in')">Pulgadas (")</div>
                        <div class="radio-btn" id="btnDiaMm" onclick="toggleDiaUnit('mm')">Milímetros (mm)</div>
                    </div>
                    <div id="inputDiaIn"><select id="byDiaSel"><option value="2">2"</option><option value="3">3"</option><option value="4" selected>4"</option><option value="6">6"</option><option value="8">8"</option><option value="10">10"</option><option value="12">12"</option></select></div>
                    <div id="inputDiaMm" style="display:none;"><input type="number" id="byDiaInp" placeholder="Ej: 100"></div>
                </div>

                <div class="input-group">
                    <label>Radio Codo</label>
                    <div class="radio-group">
                        <div class="radio-btn active" id="byLR" onclick="setByRad('LR')">Largo (x1.5)</div>
                        <div class="radio-btn" id="bySR" onclick="setByRad('SR')">Corto (x1.0)</div>
                    </div>
                </div>

                <button class="btn-main" style="margin-top:15px;" onclick="calcBayonetaPro()">Calcular Trazado</button>
            </div>

            <div id="resByPro" style="display:none;">
                <div class="canvas-wrap" style="padding:0; height:auto; min-height:350px;">
                    <div class="canvas-label" style="z-index:10; background:rgba(0,0,0,0.5);">Isométrico de Tubería</div>
                    <div style="position:absolute; top:10px; right:10px; z-index:10;">
                        <button class="btn-mini" onclick="flipIso()" id="btnFlip">GIRAR VISTA ⟲</button>
                    </div>
                    <svg id="bySvg" style="width:100%; height:100%; min-height:350px; background:#111827;"></svg>
                </div>

                <div class="card" style="background:rgba(74, 222, 128, 0.1); border:1px solid var(--workshop-green);">
                    <table class="data-table" style="color:white;">
                        <tr><td style="text-align:left; color:#86efac;">Ángulo Codos</td><td style="font-weight:900; font-size:1.1rem; color:#86efac;" id="outByAng">0°</td></tr>
                        <tr><td style="text-align:left;">Recorrido (C-C)</td><td style="font-weight:bold;" id="outByTrav">0</td></tr>
                        <tr><td style="text-align:left;">Avance Codo (x2)</td><td style="font-weight:bold; color:#fca5a5;" id="outByDesc">0</td></tr>
                        <tr style="background:rgba(74, 222, 128, 0.2);"><td style="text-align:left; font-weight:800; color:#4ade80;">CARRETE (CORTE)</td><td style="font-weight:900; font-size:1.4rem; color:#4ade80;" id="outByCut">0</td></tr>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-bridas" class="section"><h2>Manual ASME B16.5</h2><div class="card"><div class="input-group"><label>NPS</label><select id="brSize"><option value="2">2"</option><option value="4" selected>4"</option><option value="6">6"</option><option value="8">8"</option></select></div><div class="input-group"><label>Clase</label><select id="brClass"><option value="150">150#</option><option value="300">300#</option></select></div><button class="btn-main" onclick="getBrida()">Consultar</button></div><div id="brRes" class="card" style="display:none"><table class="data-table"><tr><td>Ext.</td><td id="brOD">0</td></tr><tr><td>Centro</td><td id="brBC">0</td></tr><tr><td>Agujeros</td><td id="brH">0</td></tr></table></div></div>
        <div id="tab-pesos" class="section"><h2>Cálculo de Pesos</h2><div class="card"><div class="input-group"><label>Diámetro</label><select id="pD"><option value="4">4"</option><option value="6">6"</option></select></div><div class="input-group"><label>Largo (m)</label><input type="number" id="pL"></div><button class="btn-main" onclick="calcPeso()">Calcular</button></div><div id="resP" class="card" style="display:none; text-align:center;"><div id="resPVal" style="font-size:1.5rem; font-weight:bold;">0 Kg</div></div></div>
        <div id="tab-codos" class="section"><h2>Avance Codos</h2><div class="card"><div class="input-group"><label>Diámetro</label><input type="number" id="coD"></div><div class="input-group"><label>Ángulo</label><input type="number" id="coA" value="90"></div><button class="btn-main" onclick="calcCo()">Calcular</button></div><div id="resCo" class="card" style="display:none; text-align:center;"><div id="resCoVal" style="font-size:1.5rem; font-weight:bold;">0 mm</div></div></div>
        <div id="tab-cargas" class="section"><h2>Eslingas</h2><div id="slingList"></div></div>

    </div>
</div>

<script>
    window.addEventListener('load', () => { setTimeout(() => { document.getElementById('splash-screen').style.opacity = '0'; setTimeout(() => { document.getElementById('splash-screen').style.display = 'none'; }, 800); }, 2500); });

    // Variables
    let unitBP='in', divBP=16, exportFormat='a4', coType='LR';
    let lastBP = { pts: [], per: 0, r: 0, c: 0, R_cab_mm: 0, r_ram_mm: 0, angRad: 0, unit: 'in', paso: 0, angle: 90, margin: 0, minY_raw: 0 };
    let isoFlip = false; // Estado para invertir la vista isométrica

    function showMsg(t) { const b=document.getElementById('ui-message'); b.innerText=t; b.style.display='block'; setTimeout(()=>b.style.display='none',3000); }
    function setTab(id, b) { document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(btn=>btn.classList.remove('active')); document.getElementById(id).classList.add('active'); b.classList.add('active'); }
    function setFormat(f) { exportFormat=f; document.getElementById('formatA4').classList.toggle('active',f==='a4'); document.getElementById('formatA3').classList.toggle('active',f==='a3'); }
    function getOD(inch) { const m={"2":60.3,"3":88.9,"4":114.3,"6":168.3,"8":219.1,"10":273.0,"12":323.8}; return m[inch]||inch*25.4; }
    
    function setUn(u) { unitBP=u; document.getElementById('unIn').classList.toggle('active',u==='in'); document.getElementById('unMm').classList.toggle('active',u==='mm'); }
    function setDiv(d) { divBP=d; document.getElementById('div8').classList.toggle('active',d===8); document.getElementById('div16').classList.toggle('active',d===16); }

    // --- BOCA PEZ ---
    function calcBP() {
        let cIn=parseFloat(document.getElementById('bpC').value), rIn=parseFloat(document.getElementById('bpR').value), ang=parseFloat(document.getElementById('bpAng').value);
        let marg=document.getElementById('bpMarg').checked?30:10;
        if(!cIn||!rIn||!ang){showMsg("Faltan datos");return;}
        let R_cab=(unitBP==='in'?getOD(cIn):cIn)/2, r_ram=(unitBP==='in'?getOD(rIn):rIn)/2, angRad=ang*Math.PI/180;
        if(r_ram>R_cab){showMsg("Ramal > Cabezal");return;}
        let per=r_ram*2*Math.PI, paso=per/divBP, rawPts=[];
        for(let i=0;i<=divBP;i++){
            let phi=(i*360/divBP)*Math.PI/180;
            let y=(Math.sqrt(Math.pow(R_cab,2)-Math.pow(r_ram*Math.sin(phi),2))/Math.sin(angRad))-(r_ram*Math.cos(phi)/Math.tan(angRad));
            rawPts.push(y);
        }
        let minY=Math.min(...rawPts), finalPts=rawPts.map(y=>(y-minY)+marg);
        lastBP={per, r:rIn, c:cIn, pts:finalPts, unit:unitBP, paso, angle:ang, margin:marg, R_cab_mm:R_cab, r_ram_mm:r_ram, angRad, minY_raw:minY};
        let tb=document.querySelector("#tableBP tbody"); tb.innerHTML="";
        lastBP.pts.forEach((p,i)=>{tb.innerHTML+=`<tr><td>${i}</td><td>${(i*360/divBP).toFixed(0)}°</td><td>${p.toFixed(1)}</td></tr>`;});
        document.getElementById('resBP').style.display='block';
        document.getElementById('bpPer').innerText=per.toFixed(1); document.getElementById('bpPas').innerText=paso.toFixed(1);
        drawTemplateSvg();
    }

    function drawTemplateSvg() {
        let svg=document.getElementById('bpSvg'), w=400, h=160, step=w/(lastBP.pts.length-1);
        let maxVal=Math.max(...lastBP.pts), scY=(h-20)/(maxVal||1), path=`M 0 ${h}`;
        lastBP.pts.forEach((p,i)=>{ path+=` L ${i*step} ${h-(p*scY)}`; }); path+=` L 400 ${h} Z`;
        let fajaY=h-(lastBP.margin*scY);
        svg.innerHTML=`<rect width="400" height="160" fill="#0f172a"/><line x1="0" y1="${fajaY}" x2="400" y2="${fajaY}" stroke="#facc15" stroke-dasharray="4"/><path d="${path}" stroke="#38bdf8" stroke-width="2" fill="rgba(56,189,248,0.2)"/>`;
    }

    // --- PDF EXPORT (Igual que antes pero resumido) ---
    function pdfMultiPaginado() {
        if(!lastBP.pts.length)return;
        document.getElementById('loading-overlay').style.display='flex';
        setTimeout(()=>{
            const { jsPDF } = window.jspdf; const doc=new jsPDF({orientation:'l', unit:'mm', format:exportFormat});
            let hdPts=[]; for(let i=0;i<=360;i++){
                let phi=(i*Math.PI/180);
                let y=(Math.sqrt(Math.pow(lastBP.R_cab_mm,2)-Math.pow(lastBP.r_ram_mm*Math.sin(phi),2))/Math.sin(lastBP.angRad))-(lastBP.r_ram_mm*Math.cos(phi)/Math.tan(lastBP.angRad));
                hdPts.push({x:(i/360)*lastBP.per, y:(y-lastBP.minY_raw)+lastBP.margin});
            }
            let pW=(exportFormat==='a3'?420:297)-40, nP=Math.ceil(lastBP.per/pW);
            for(let p=0;p<nP;p++){
                if(p>0)doc.addPage();
                doc.setFontSize(10); doc.text(`PLANTILLA 1:1 - PÁG ${p+1}/${nP}`, 20, 15);
                let start=p*pW, end=(p+1)*pW, yBase=180;
                doc.line(20, yBase-lastBP.margin, 20+pW, yBase-lastBP.margin); // Faja
                for(let i=0;i<hdPts.length-1;i++){
                    let p1=hdPts[i], p2=hdPts[i+1];
                    if(p2.x>start && p1.x<end){
                        let x1=(p1.x-start)+20, y1=yBase-p1.y, x2=(p2.x-start)+20, y2=yBase-p2.y;
                        if(x1>=20 && x2<=20+pW) doc.line(x1,y1,x2,y2);
                    }
                }
                doc.line(20, yBase, 20+pW, yBase); // Base
            }
            doc.save(`Plantilla_Xurxo_${lastBP.r}.pdf`);
            document.getElementById('loading-overlay').style.display='none';
        },1000);
    }
    
    async function pdfInforme() {
         document.getElementById('loading-overlay').style.display='flex';
         document.getElementById('nav-ignore').style.display='none';
         document.getElementById('form-ignore').style.display='none';
         document.getElementById('btns-ignore').style.display='none';
         const canvas = await html2canvas(document.getElementById('capture-area'), {scale:2});
         const img = canvas.toDataURL('image/png');
         const pdf = new window.jspdf.jsPDF();
         pdf.addImage(img,'PNG',10,20,190,0);
         pdf.save('Informe_Tubero.pdf');
         document.getElementById('nav-ignore').style.display='grid';
         document.getElementById('form-ignore').style.display='block';
         document.getElementById('btns-ignore').style.display='block';
         document.getElementById('loading-overlay').style.display='none';
    }

    // --- BAYONETA ISO TÉCNICO ---
    let byType='LR', byUnitDia='in';
    function setByRad(t){ byType=t; document.getElementById('byLR').classList.toggle('active',t==='LR'); document.getElementById('bySR').classList.toggle('active',t==='SR'); }
    function toggleDiaUnit(u){ byUnitDia=u; document.getElementById('btnDiaIn').style.display=u==='in'?'block':'none'; document.getElementById('inputDiaMm').style.display=u==='mm'?'block':'none'; document.getElementById('btnDiaIn').classList.toggle('active',u==='in'); document.getElementById('btnDiaMm').classList.toggle('active',u==='mm'); }
    function toggleRoll(){ const c=document.getElementById('checkRolling').checked; document.getElementById('groupRoll').style.display=c?'block':'none'; document.getElementById('byRoll').value=''; }
    function flipIso(){ isoFlip = !isoFlip; calcBayonetaPro(); }

    function calcBayonetaPro() {
        let run=parseFloat(document.getElementById('byRun').value), set=parseFloat(document.getElementById('bySet').value);
        let roll=parseFloat(document.getElementById('byRoll').value)||0, isRoll=document.getElementById('checkRolling').checked;
        if(isRoll && !roll){showMsg("Falta Roll");return;}
        
        // Calcular Efectivo
        let effSet = set;
        if(isRoll) effSet = Math.sqrt(set*set + roll*roll);
        
        let diaBase = (byUnitDia==='in') ? parseFloat(document.getElementById('byDiaSel').value)*25.4 : parseFloat(document.getElementById('byDiaInp').value);
        if(!run || !set || !diaBase){showMsg("Faltan datos");return;}

        let travel = Math.sqrt(run*run + effSet*effSet);
        let angRad = Math.atan(effSet/run), angDeg = angRad*180/Math.PI;
        let radius = (byType==='LR')? diaBase*1.5 : diaBase;
        let deduct = (radius * Math.tan(angRad/2)) * 2;
        let cut = travel - deduct;

        document.getElementById('resByPro').style.display='block';
        document.getElementById('outByAng').innerText = angDeg.toFixed(1)+"°";
        document.getElementById('outByTrav').innerText = travel.toFixed(1)+" mm";
        document.getElementById('outByDesc').innerText = "-"+deduct.toFixed(1);
        
        let cutEl = document.getElementById('outByCut');
        cutEl.innerText = cut<0 ? "IMPOSIBLE" : cut.toFixed(1)+" mm";
        cutEl.style.color = cut<0 ? "#ef4444" : "#4ade80";

        drawIsoTechnical(run, set, isRoll?roll:0, cut);
    }

    function drawIsoTechnical(run, set, roll, cut) {
        const svg = document.getElementById('bySvg');
        svg.innerHTML = '';
        
        // Definir Puntos en 3D (x, y, z)
        // Usaremos proyección isométrica estándar:
        // X = Eje 30° Derecha (Run)
        // Y = Eje Vertical (Set)
        // Z = Eje 30° Izquierda (Roll)
        // Origen en el centro
        
        let dir = isoFlip ? -1 : 1; // Invertir dirección X

        // Coordenadas 3D relativas
        // P0: Inicio
        // P1: Final del Run (se mueve en eje X)
        // P2: Final del Roll (se mueve en eje Z desde P1)
        // P3: Final del Set (se mueve en eje Y desde P2)
        
        let p0 = {x:0, y:0, z:0};
        let p1 = {x: run * dir, y:0, z:0};
        let p2 = {x: run * dir, y:0, z: roll}; // Si roll es 0, p2=p1
        let p3 = {x: run * dir, y: set, z: roll};

        // Proyección Isométrica 2D
        // ScreenX = (x - z) * cos(30)
        // ScreenY = (x + z) * sin(30) - y  (Y es negativo hacia arriba en SVG, aquí Y positivo es arriba en 3D, así que restamos)
        // Ajustamos para SVG donde Y aumenta hacia abajo. 
        // 3D Y+ (Up) -> SVG Y-
        
        const angle = 30 * Math.PI / 180;
        const cos30 = Math.cos(angle);
        const sin30 = Math.sin(angle);

        function toIso(pt) {
            return {
                x: (pt.x - pt.z) * cos30,
                y: (pt.x + pt.z) * sin30 - pt.y // Proyección estándar ISO
            };
        }

        let s0 = toIso(p0);
        let s1 = toIso(p1);
        let s2 = toIso(p2);
        let s3 = toIso(p3);

        // ViewBox Auto-fit
        let pts = [s0, s1, s2, s3];
        let minX = Math.min(...pts.map(p=>p.x)), maxX = Math.max(...pts.map(p=>p.x));
        let minY = Math.min(...pts.map(p=>p.y)), maxY = Math.max(...pts.map(p=>p.y));
        let w = maxX - minX, h = maxY - minY;
        let pad = Math.max(w,h) * 0.5 + 60;
        
        // Centrar
        svg.setAttribute("viewBox", `${minX - pad} ${minY - pad} ${w + pad*2} ${h + pad*2}`);

        // Defs: Marcadores de cotas
        svg.innerHTML += `<defs><marker id="arrow" markerWidth="6" markerHeight="6" refX="0" refY="3" orient="auto"><path d="M0,0 L0,6 L6,3 z" fill="#94a3b8"/></marker></defs>`;

        // ESTILOS
        const colRun = "#38bdf8"; // Azul
        const colSet = "#ef4444"; // Rojo
        const colRoll = "#4ade80"; // Verde
        const colPipe = cut < 0 ? "#b91c1c" : "#facc15"; // Amarillo/Oro
        const lnW = Math.max(w,h) * 0.008 + 1; // Grosor línea base

        // 1. CAJA DE ALAMBRE (Phantom Lines)
        // Línea Run (P0 -> P1)
        svg.innerHTML += `<line x1="${s0.x}" y1="${s0.y}" x2="${s1.x}" y2="${s1.y}" stroke="${colRun}" stroke-width="${lnW}" stroke-dasharray="5,5" opacity="0.6"/>`;
        // Línea Roll (P1 -> P2) (Solo si hay roll)
        if(roll > 0) svg.innerHTML += `<line x1="${s1.x}" y1="${s1.y}" x2="${s2.x}" y2="${s2.y}" stroke="${colRoll}" stroke-width="${lnW}" stroke-dasharray="5,5" opacity="0.6"/>`;
        // Línea Set (P2 -> P3)
        svg.innerHTML += `<line x1="${s2.x}" y1="${s2.y}" x2="${s3.x}" y2="${s3.y}" stroke="${colSet}" stroke-width="${lnW}" stroke-dasharray="5,5" opacity="0.6"/>`;
        
        // Líneas de cierre del cubo (opcional para dar volumen)
        if(roll > 0) {
            // Diagonal suelo (P0 -> P2)
             svg.innerHTML += `<line x1="${s0.x}" y1="${s0.y}" x2="${s2.x}" y2="${s2.y}" stroke="#475569" stroke-width="${lnW/2}" stroke-dasharray="2,2"/>`;
        }

        // 2. TUBERÍA (Centerline gruesa)
        const pipeW = lnW * 3;
        // P0 -> P3 Directo
        svg.innerHTML += `<line x1="${s0.x}" y1="${s0.y}" x2="${s3.x}" y2="${s3.y}" stroke="${colPipe}" stroke-width="${pipeW}" stroke-linecap="round"/>`;
        
        // Puntos de conexión (Codos)
        let rDot = pipeW * 1.2;
        svg.innerHTML += `<circle cx="${s0.x}" cy="${s0.y}" r="${rDot}" fill="#1e293b" stroke="${colPipe}" stroke-width="2"/>`;
        svg.innerHTML += `<circle cx="${s3.x}" cy="${s3.y}" r="${rDot}" fill="#1e293b" stroke="${colPipe}" stroke-width="2"/>`;

        // 3. ETIQUETAS DE TEXTO (Technical Labels)
        const fSize = lnW * 5; 
        
        function drawText(txt, pA, pB, color, offset=1) {
            let mx = (pA.x + pB.x)/2, my = (pA.y + pB.y)/2;
            // Pequeño fondo oscuro
            let tw = txt.length * fSize * 0.6;
            svg.innerHTML += `<rect x="${mx - tw/2}" y="${my - fSize/1.5}" width="${tw}" height="${fSize}" fill="rgba(15,23,42,0.8)" rx="4"/>`;
            svg.innerHTML += `<text x="${mx}" y="${my + fSize*0.3}" fill="${color}" font-size="${fSize}" text-anchor="middle" font-weight="bold" font-family="monospace">${txt}</text>`;
        }

        drawText(`RUN:${run}`, s0, s1, colRun);
        if(roll>0) drawText(`ROLL:${roll}`, s1, s2, colRoll);
        drawText(`SET:${set}`, s2, s3, colSet);

        // Etiqueta Corte (Centro Tubo)
        if(cut>0){
            let cx = (s0.x + s3.x)/2, cy = (s0.y + s3.y)/2;
            svg.innerHTML += `<rect x="${cx - fSize*3}" y="${cy - fSize*2.5}" width="${fSize*6}" height="${fSize*1.4}" fill="${colPipe}" stroke="black" rx="4"/>`;
            svg.innerHTML += `<text x="${cx}" y="${cy - fSize*1.6}" fill="black" font-size="${fSize}" font-weight="900" text-anchor="middle">CORTE: ${cut.toFixed(0)}</text>`;
        }

        // 4. BRÚJULA NORTE (Referencia)
        let nx = minX - pad + 30, ny = minY - pad + 40;
        svg.innerHTML += `<path d="M ${nx} ${ny} L ${nx+15} ${ny-20} L ${nx+30} ${ny} L ${nx+15} ${ny-5} Z" fill="#94a3b8"/>`;
        svg.innerHTML += `<text x="${nx+15}" y="${ny-25}" fill="#94a3b8" font-size="10" text-anchor="middle" font-weight="bold">N</text>`;
    }
    
    // --- HELPERS BRIDAS ETC ---
    const dbB={"150":{"2":{od:152.4,bc:120.7,h:4},"4":{od:228.6,bc:190.5,h:8}},"300":{"4":{od:254,bc:200.2,h:8}}};
    function getBrida(){let s=document.getElementById('brSize').value,c=document.getElementById('brClass').value,d=dbB[c][s]; if(d){document.getElementById('brRes').style.display='block';document.getElementById('brOD').innerText=d.od;document.getElementById('brBC').innerText=d.bc;document.getElementById('brH').innerText=d.h;}}
    function calcPeso(){document.getElementById('resP').style.display='block';document.getElementById('resPVal').innerText=(16.1*document.getElementById('pL').value).toFixed(1)+" Kg";}
    function calcCo(){let d=document.getElementById('coD').value;document.getElementById('resCo').style.display='block';document.getElementById('resCoVal').innerText=(d*38.1).toFixed(1)+" mm";}
    
    // Eslingas
    const sl=[{c:'#7c3aed',n:'VIOLETA',t:1},{c:'#16a34a',n:'VERDE',t:2},{c:'#facc15',n:'AMARILLO',t:3},{c:'#ef4444',n:'ROJO',t:5}];
    document.getElementById('slingList').innerHTML=sl.map(s=>`<div class="sling-row"><div style="width:30px;height:30px;border-radius:50%;background:${s.c}"></div><div style="flex:1;font-weight:bold;color:#cbd5e1">${s.n}</div><div style="font-size:1.2rem;font-weight:900;color:white;">${s.t}T</div></div>`).join('');
</script>
</body>
</html>
